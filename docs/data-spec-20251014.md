# データ仕様（C）— GROQ クエリ設計と項目表（2025-10-14）

目的: “給排水を通す”段階として、各ページが最低限の実データで動くための GROQ を固定する。
例え話: 建物に水道・電気（データ供給）を先に引き込むイメージ。

---

## 共通前提（Sanity）
- スキーマ: `post` は `category`（reference to `category`）と `tags`（reference array）を持つ。
- 分類: カテゴリは `category.slug.current` をキー（例: `money`, `parenting` ...）。
- 画像: `heroImage.asset->url` を投影。必要に応じて `@sanity/image-url` で最適化。
- キャッシュ: ISR を基本（トップ: 60s、カテゴリ: 60–120s、記事: 300s 目安）。
- 安全: `server-only` + 読み取りトークンはサーバー環境変数（`SANITY_READ_TOKEN`）のみで扱う。

```ts
// 共通プロジェクション（再利用）
const postFields = `{
  _id,
  title,
  "slug": slug.current,
  excerpt,
  heroImage,
  "imageUrl": heroImage.asset->url,
  publishedAt,
  updatedAt,
  // カテゴリ（ref）
  "category": category->slug.current,
  "categoryTitle": category->title,
  // タグ（ref→light）
  "tags": tags[]-> { _id, title, "slug": slug.current }
}`
```

---

## 1) latestByCategory（カテゴリ別の最新）
- 役割（例え）: 各フロアの「今日の新商品」棚。
- 入力: `{ category: string; limit: number }`
- 出力: `postFields[]`（新着順）
- GROQ:
```groq
*[_type == "post" && defined(slug.current) && category->slug.current == $category]
| order(publishedAt desc)[0...$limit]
${postFields}
```
- 備考: `publishedAt` 未設定の文書は除外/最後尾に送られる。品質担保として `validation` 済み前提。

---

## 2) listByCategory（カテゴリ一覧 + 並び替え/期間）
- 役割（例え）: フロアの「棚並べ替え」札（新着/人気、全期間/直近）。
- 入力: `{ category: string; sort: "new" | "popular"; days?: 30 | "all"; offset: number; limit: number }`
- 出力: `postFields[]`
- GROQ（新着/期間フィルタ例）
```groq
{
  "list": *[_type == "post" && defined(slug.current)
            && category->slug.current == $category
            && (!defined($since) || publishedAt >= $since)]
          | order(publishedAt desc)[$offset...$end]
          ${postFields},
  "total": count(*[_type == "post" && defined(slug.current)
                  && category->slug.current == $category
                  && (!defined($since) || publishedAt >= $since)])
}
```
- popular（人気順）について:
  - `views` フィールドがある場合: `order(coalesce(views,0) desc, publishedAt desc)`
  - ない場合: フォールバックとして `publishedAt desc` を使う（UI は人気/新着の切替を許容）。
- 期間パラメータ: `days == 30` のとき `$since = now() - 60*60*24*30`

---

## 3) postByCategorySlug（記事詳細）
- 役割（例え）: 商品詳細ページ（仕様/写真/関連棚）。
- 入力: `{ category: string; slug: string }`
- 出力: 詳細 + 関連情報（本文 / タグ / 画像 URL）
- GROQ:
```groq
*[_type == "post" && defined(slug.current)
  && slug.current == $slug && category->slug.current == $category][0]{
  _id,
  title,
  "slug": slug.current,
  excerpt,
  heroImage,
  "imageUrl": heroImage.asset->url,
  publishedAt,
  updatedAt,
  "category": category->slug.current,
  "categoryTitle": category->title,
  body,
  adsPlacement,
  // タグ（ref→full）
  "tags": tags[]-> { _id, title, "slug": slug.current }
}
```
- 備考: 本文は Portable Text。画像・リンク強化は別バッチ（enrich）で補完済み想定。

---

## 4) relatedByTags（関連記事）
- 役割（例え）: 近くの関連棚（同じタグ）を案内。
- 入力: `{ slug: string; tags: string[] /* tag slug */ }`
- 出力: `postFields[]`（最大4件）
- GROQ:
```groq
*[_type == "post" && defined(slug.current) && slug.current != $slug
  && count(tags[]->slug.current[@ in $tags]) > 0]
| order(publishedAt desc)[0...4]
${postFields}
```
- 代替: タグが空なら `category` ベースの最新4件にフォールバック。

---

## 5) searchPosts（全文検索の最小）
- 役割（例え）: 案内所に「探し物」を伝える。
- 入力: `{ q: string; sort?: "relevance" | "new"; days?: 30 | "all"; limit: number }`
- 出力: `postFields[]` + `score`
- GROQ（簡易スコア）
```groq
let $since = defined($since) ? $since : null;
*[_type == "post" && defined(slug.current)
  && (!defined($since) || publishedAt >= $since)
  && (title match $q || excerpt match $q || body[].children[].text match $q)]
| order(defined($sort) && $sort == "new" => publishedAt desc,
        defined($sort) && $sort == "relevance" => score(desc))
[0...$limit]{
  ...${postFields},
  // 簡易スコア（必要に応じて weight 調整）
  "score": score(title match $q) + score(excerpt match $q) + score(body[].children[].text match $q)
}
```
- 備考: 高度なスコアリングが必要なら Pipeline 段で `searchIndex` を生成し、そこで集約。

---

## 6) sitemap / rss 用（補助）
- 役割（例え）: 館内マップと新着チラシ。
- all slugs:
```groq
*[_type == "post" && defined(slug.current)]{ "slug": slug.current, "category": category->slug.current }
```
- recent N for rss:
```groq
*[_type == "post" && defined(slug.current)]|order(publishedAt desc)[0...50]{
  title, "slug": slug.current, "category": category->slug.current, excerpt, publishedAt
}
```

---

## エッジケース / フォールバック
- `publishedAt` 未設定: 一覧・最新から除外（または最後尾）
- `heroImage` 未設定: プレースホルダー画像（`/public` or デザインで型崩れ回避）
- タグ無し: `relatedByTags` はカテゴリ最新にフォールバック
- 人気順（views）未導入: `order(publishedAt desc)` を用いて UI の一貫性を保つ

## Next.js 側の推奨
- `revalidate` 目安: トップ60s / カテゴリ60–120s / 記事300s / 検索は動的（cache: no-store）
- ページ遷移: カテゴリ・検索は `searchParams` を URL に保持（戻る操作で復元）
- 型: `types/post.ts` を用意し、`postFields` の投影結果と一致させる

---

## 実装ToDo（短時間の着手順）
- [ ] `mamasanlife-site/lib/queries.ts` を本仕様に揃える（category を ref 前提に）
- [ ] `app/page.tsx`（トップ）: latestByCategory + recent
- [ ] `app/[category]/page.tsx`: listByCategory（sort/days/offset/limit）
- [ ] `app/[category]/[slug]/page.tsx`: postByCategorySlug + relatedByTags
- [ ] `app/search/page.tsx`: searchPosts（最小）
- [ ] `app/sitemap.ts` / `app/rss.xml/route.ts`: sitemap/rss を共通投影で

例え話まとめ: 「まず水道管（GROQ）を通し、蛇口（各ページ）から“いつでも同じ形の水（postFields）”が出るようにする。棚の並べ替え（sort/days）はバルブで調整、人気順が無いときは水圧（新着順）に戻す。」
